name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - uses: actions/checkout@v4

    - &setup-python
      name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - &install-uv
      name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - &install-deps
      name: Install dependencies
      run: |
        uv sync

    - name: Run lint suite
      run: |
        make lint format-check

  typecheck:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - uses: actions/checkout@v4

    - *setup-python
    - *install-uv
    - *install-deps

    - name: Run mypy (generate type coverage reports)
      run: |
        make mypy-coverage

    - name: Run pyright (strict, non-blocking)
      run: |
        make pyright

    # - name: Upload type coverage to Codecov
    #   uses: codecov/codecov-action@v5
    #   with:
    #     name: type-coverage
    #     files: ./mypy_reports/type_cobertura/cobertura.xml
    #     flags: typecov
    #     verbose: true
    #     use_oidc: true
    #   env:
    #     CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload type coverage HTML
      uses: actions/upload-artifact@v4
      with:
        name: type-coverage-html
        path: mypy_reports/type_html/

  test-saas:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - uses: actions/checkout@v4

    - *setup-python
    - *install-uv
    - *install-deps

    - name: Verify E2B credentials
      env:
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
      run: |
        if [ -z "$E2B_API_KEY" ]; then
          echo "::error::E2B_API_KEY secret is not set. E2B tests would be silently skipped."
          exit 1
        fi

    - name: Run tests with coverage (E2B SaaS)
      env:
        LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        LLM_MODEL: ${{ vars.LLM_MODEL }}
        LLM_BASE_URL: ${{ vars.LLM_BASE_URL }}
        E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
      run: |
        make test

    - name: Upload test coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        name: test-coverage-saas
        files: ./coverage.xml
        flags: unittests-saas
        verbose: true
        use_oidc: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload test coverage HTML
      uses: actions/upload-artifact@v4
      with:
        name: test-coverage-html-saas
        path: htmlcov/

  test-selfhost:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - uses: actions/checkout@v4

    - *setup-python
    - *install-uv
    - *install-deps

    - name: Verify E2B Self-Host credentials
      env:
        E2B_API_KEY: ${{ secrets.E2B_SELFHOST_API_KEY }}
        E2B_API_URL: ${{ vars.E2B_SELFHOST_API_URL }}
        E2B_DOMAIN: ${{ vars.E2B_SELFHOST_DOMAIN }}
      run: |
        if [ -z "$E2B_API_KEY" ]; then
          echo "::error::E2B_SELFHOST_API_KEY secret is not set. Self-host E2B tests would be silently skipped."
          exit 1
        fi
        if [ -z "$E2B_API_URL" ]; then
          echo "::error::E2B_SELFHOST_API_URL variable is not set."
          exit 1
        fi
        if [ -z "$E2B_DOMAIN" ]; then
          echo "::error::E2B_SELFHOST_DOMAIN variable is not set."
          exit 1
        fi

    - name: Run tests with coverage (E2B Self-Host)
      env:
        LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        LLM_MODEL: ${{ vars.LLM_MODEL }}
        LLM_BASE_URL: ${{ vars.LLM_BASE_URL }}
        E2B_API_KEY: ${{ secrets.E2B_SELFHOST_API_KEY }}
        E2B_API_URL: ${{ vars.E2B_SELFHOST_API_URL }}
        E2B_DOMAIN: ${{ vars.E2B_SELFHOST_DOMAIN }}
      run: |
        uv run pytest tests/unit/archs/sandbox/ \
          --cov=nexau.archs.sandbox \
          --cov-report=xml --cov-report=html --cov-report=term \
          -x --timeout=120

    - name: Upload test coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        name: test-coverage-selfhost
        files: ./coverage.xml
        flags: unittests-selfhost
        verbose: true
        use_oidc: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload test coverage HTML
      uses: actions/upload-artifact@v4
      with:
        name: test-coverage-html-selfhost
        path: htmlcov/
