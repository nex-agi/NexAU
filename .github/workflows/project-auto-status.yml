name: "Project: Auto Backlog → Todo when Iteration set"

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  auto-status:
    runs-on: ubuntu-latest
    steps:
      - name: Move Backlog items with Iteration to Todo
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          set -euo pipefail

          PROJECT_ID="PVT_kwDOCmnEdM4BQARn"
          STATUS_FIELD_ID="PVTSSF_lADOCmnEdM4BQARnzg-P8lI"
          BACKLOG_OPTION_ID="c8979f55"
          TODO_OPTION_ID="f75ad846"

          echo "Fetching project items with Status=Backlog..."

          HAS_NEXT=true
          CURSOR=""
          MOVED=0

          while [ "$HAS_NEXT" = "true" ]; do
            if [ -z "$CURSOR" ]; then
              AFTER_ARG=""
            else
              AFTER_ARG=", after: \"$CURSOR\""
            fi

            RESPONSE=$(gh api graphql -f query="
            {
              node(id: \"$PROJECT_ID\") {
                ... on ProjectV2 {
                  items(first: 100${AFTER_ARG}) {
                    pageInfo {
                      hasNextPage
                      endCursor
                    }
                    nodes {
                      id
                      statusVal: fieldValueByName(name: \"Status\") {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          optionId
                          name
                        }
                      }
                      iterVal: fieldValueByName(name: \"Iteration\") {
                        ... on ProjectV2ItemFieldIterationValue {
                          iterationId
                          title
                        }
                      }
                      content {
                        ... on Issue {
                          title
                          number
                          repository { nameWithOwner }
                        }
                      }
                    }
                  }
                }
              }
            }")

            HAS_NEXT=$(echo "$RESPONSE" | jq -r '.data.node.items.pageInfo.hasNextPage')
            CURSOR=$(echo "$RESPONSE" | jq -r '.data.node.items.pageInfo.endCursor')

            ITEMS=$(echo "$RESPONSE" | jq -c '.data.node.items.nodes[]')

            while IFS= read -r ITEM; do
              [ -z "$ITEM" ] && continue

              ITEM_ID=$(echo "$ITEM" | jq -r '.id')
              STATUS_OPT=$(echo "$ITEM" | jq -r '.statusVal.optionId // ""')
              ITER_ID=$(echo "$ITEM" | jq -r '.iterVal.iterationId // ""')
              TITLE=$(echo "$ITEM" | jq -r '.content.title // "Draft"')
              NUM=$(echo "$ITEM" | jq -r '.content.number // ""')
              ITER_TITLE=$(echo "$ITEM" | jq -r '.iterVal.title // ""')

              if [ "$STATUS_OPT" = "$BACKLOG_OPTION_ID" ] && [ -n "$ITER_ID" ]; then
                echo "Moving: #$NUM $TITLE (iteration: $ITER_TITLE) → Todo"
                gh api graphql -f query="
                mutation {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: \"$PROJECT_ID\"
                    itemId: \"$ITEM_ID\"
                    fieldId: \"$STATUS_FIELD_ID\"
                    value: { singleSelectOptionId: \"$TODO_OPTION_ID\" }
                  }) {
                    projectV2Item { id }
                  }
                }" > /dev/null
                MOVED=$((MOVED + 1))
              fi
            done <<< "$ITEMS"
          done

          echo "Done. Moved $MOVED item(s) from Backlog to Todo."
